<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuralMemory - Brain Visualization</title>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #1a1a2e;
            color: #eee;
        }
        .container {
            display: flex;
            height: 100vh;
        }
        .sidebar {
            width: 300px;
            background: #16213e;
            padding: 20px;
            overflow-y: auto;
        }
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .header {
            background: #0f3460;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 1.5rem;
            color: #e94560;
        }
        .stats {
            display: flex;
            gap: 20px;
        }
        .stat {
            text-align: center;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #e94560;
        }
        .stat-label {
            font-size: 0.8rem;
            color: #aaa;
        }
        #graph {
            flex: 1;
            background: #1a1a2e;
        }
        .sidebar h2 {
            color: #e94560;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        .sidebar h3 {
            color: #aaa;
            margin: 15px 0 10px;
            font-size: 0.9rem;
            text-transform: uppercase;
        }
        .brain-select {
            width: 100%;
            padding: 10px;
            background: #0f3460;
            border: 1px solid #e94560;
            color: #eee;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .btn {
            width: 100%;
            padding: 10px;
            background: #e94560;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        .btn:hover {
            background: #ff6b6b;
        }
        .btn-secondary {
            background: #0f3460;
            border: 1px solid #e94560;
        }
        .btn-secondary:hover {
            background: #16213e;
        }
        .node-info {
            background: #0f3460;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }
        .node-info p {
            margin: 5px 0;
            font-size: 0.85rem;
        }
        .node-info .label {
            color: #aaa;
        }
        .node-info .value {
            color: #eee;
        }
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 1.2rem;
            color: #aaa;
        }
        .error {
            color: #ff6b6b;
            padding: 10px;
            background: rgba(255,107,107,0.1);
            border-radius: 5px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <h2>NeuralMemory</h2>

            <select id="brainSelect" class="brain-select">
                <option value="">Loading brains...</option>
            </select>

            <button class="btn" onclick="loadGraph()">Refresh Graph</button>
            <button class="btn btn-secondary" onclick="resetView()">Reset View</button>

            <h3>Statistics</h3>
            <div class="stats" style="flex-direction: column; gap: 10px;">
                <div class="stat" style="text-align: left;">
                    <span class="stat-label">Neurons: </span>
                    <span class="stat-value" id="neuronCount">0</span>
                </div>
                <div class="stat" style="text-align: left;">
                    <span class="stat-label">Synapses: </span>
                    <span class="stat-value" id="synapseCount">0</span>
                </div>
                <div class="stat" style="text-align: left;">
                    <span class="stat-label">Fibers: </span>
                    <span class="stat-value" id="fiberCount">0</span>
                </div>
            </div>

            <h3>Selected Node</h3>
            <div class="node-info" id="nodeInfo">
                <p><span class="label">Click a node to see details</span></p>
            </div>

            <h3>Legend</h3>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #e94560;"></div>
                    <span>Concept</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #4ecdc4;"></div>
                    <span>Entity</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffe66d;"></div>
                    <span>Time</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #95e1d3;"></div>
                    <span>Action</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f38181;"></div>
                    <span>State</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #aa96da;"></div>
                    <span>Other</span>
                </div>
            </div>
        </aside>

        <main class="main">
            <header class="header">
                <h1>Brain Visualization</h1>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" id="visibleNodes">0</div>
                        <div class="stat-label">Visible Nodes</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="visibleEdges">0</div>
                        <div class="stat-label">Visible Edges</div>
                    </div>
                </div>
            </header>
            <div id="graph">
                <div class="loading">Loading graph...</div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let network = null;
        let allNodes = [];
        let allEdges = [];

        const COLORS = {
            concept: '#e94560',
            entity: '#4ecdc4',
            time: '#ffe66d',
            action: '#95e1d3',
            state: '#f38181',
            spatial: '#45b7d1',
            sensory: '#96ceb4',
            intent: '#dda0dd',
            default: '#aa96da'
        };

        async function loadBrains() {
            try {
                // For now, use default brain from unified config
                const select = document.getElementById('brainSelect');
                select.innerHTML = '<option value="default">default</option>';
            } catch (error) {
                console.error('Error loading brains:', error);
            }
        }

        async function loadGraph() {
            const graphContainer = document.getElementById('graph');
            graphContainer.innerHTML = '<div class="loading">Loading graph...</div>';

            try {
                const response = await fetch(`${API_BASE}/api/graph`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();

                // Update stats
                document.getElementById('neuronCount').textContent = data.stats.neuron_count;
                document.getElementById('synapseCount').textContent = data.stats.synapse_count;
                document.getElementById('fiberCount').textContent = data.stats.fiber_count;

                // Convert to vis.js format
                allNodes = data.neurons.map(n => ({
                    id: n.id,
                    label: truncate(n.content, 20),
                    title: n.content,
                    color: COLORS[n.type] || COLORS.default,
                    type: n.type,
                    content: n.content,
                    metadata: n.metadata
                }));

                allEdges = data.synapses.map(s => ({
                    id: s.id,
                    from: s.source_id,
                    to: s.target_id,
                    label: s.type,
                    title: `${s.type} (weight: ${s.weight.toFixed(2)})`,
                    arrows: s.direction === 'uni' ? 'to' : 'to, from',
                    width: Math.max(1, s.weight * 3),
                    color: { color: '#555', highlight: '#e94560' }
                }));

                renderGraph();

            } catch (error) {
                console.error('Error loading graph:', error);
                graphContainer.innerHTML = `<div class="error">Error loading graph: ${error.message}<br>Make sure the server is running with UI enabled.</div>`;
            }
        }

        function renderGraph() {
            const container = document.getElementById('graph');
            container.innerHTML = '';

            const nodes = new vis.DataSet(allNodes);
            const edges = new vis.DataSet(allEdges);

            document.getElementById('visibleNodes').textContent = allNodes.length;
            document.getElementById('visibleEdges').textContent = allEdges.length;

            const options = {
                nodes: {
                    shape: 'dot',
                    size: 16,
                    font: {
                        size: 12,
                        color: '#eee'
                    },
                    borderWidth: 2,
                    shadow: true
                },
                edges: {
                    font: {
                        size: 10,
                        color: '#888',
                        strokeWidth: 0
                    },
                    smooth: {
                        type: 'continuous'
                    }
                },
                physics: {
                    stabilization: {
                        iterations: 100
                    },
                    barnesHut: {
                        gravitationalConstant: -2000,
                        springLength: 150
                    }
                },
                interaction: {
                    hover: true,
                    tooltipDelay: 200
                }
            };

            network = new vis.Network(container, { nodes, edges }, options);

            network.on('selectNode', function(params) {
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    const node = allNodes.find(n => n.id === nodeId);
                    showNodeInfo(node);
                }
            });

            network.on('deselectNode', function() {
                document.getElementById('nodeInfo').innerHTML =
                    '<p><span class="label">Click a node to see details</span></p>';
            });
        }

        function showNodeInfo(node) {
            if (!node) return;

            const infoDiv = document.getElementById('nodeInfo');
            infoDiv.innerHTML = `
                <p><span class="label">Type:</span> <span class="value">${node.type}</span></p>
                <p><span class="label">Content:</span> <span class="value">${node.content}</span></p>
                <p><span class="label">ID:</span> <span class="value" style="font-size:0.7rem">${node.id}</span></p>
            `;
        }

        function resetView() {
            if (network) {
                network.fit();
            }
        }

        function truncate(str, len) {
            if (!str) return '';
            return str.length > len ? str.substring(0, len) + '...' : str;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadBrains();
            loadGraph();
        });
    </script>
</body>
</html>
